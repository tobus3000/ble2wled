name: Publish Python Package

on:
  push:
    branches:
      - main
  release:
    types: [published]

permissions:
  contents: read
  id-token: write  # required for trusted publishing

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'release' && 'pypi' || 'testpypi' }}

    steps:
      # Checkout full history (required for hatch-vcs)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # Cache pip dependencies
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Cache Hatch build artifacts
      - name: Cache Hatch build
        uses: actions/cache@v3
        with:
          path: dist
          key: ${{ runner.os }}-hatch-dist-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-hatch-dist-

      # Install build tools
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install hatch hatchling hatch-vcs build twine

      # Show resolved version
      - name: Show resolved version
        run: hatch version

      # Clean previous builds
      - name: Clean dist
        run: rm -rf dist/*

      # Build the distribution
      - name: Build package
        run: hatch build

      # Publish
      - name: Publish package
        run: |
          if [[ "${{ github.event_name }}" = "push" && "${{ github.actor }}" != "github-actions" ]]; then
            echo "Publishing to TestPyPI..."
            twine upload --verbose --repository testpypi dist/*
          elif [[ "${{ github.event_name }}" = "release" ]]; then
            echo "Publishing to PyPI..."
            twine upload --verbose --repository pypi dist/*
          else
            echo "Not publishing."
          fi
